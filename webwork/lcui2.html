<!DOCTYPE HTML>
<HTML>
<head>
<meta charset="UTF-8">
<style type="text/css">
html {
	height:100%;
}
body {
	height:100%;
	margin:0px;
}
.fScreen{
	float:left;
	height:500px;
	width:500px;

}
</style>
</head>
<body>
<div id="candiv"><canvas id="canvas" width="1440" height="880">!supported</canvas></div>
<script type = "text/javascript">
var wHeight = window.innerHeight;
var wWidth = window.innerWidth;
window.addEventListener('load', winloaded, false);
function winloaded(){
var candiv=document.getElementById('candiv');
var cvs=document.getElementById('canvas');
	cvs.height = wHeight;
	cvs.width = wWidth;
	//oWidth and oHeight if/else statement for mobile web browsers
	//assign width height canvas values according to screen orientation
	//user agent detection script
	//hit
app();

}
function app(){
var cvs=document.getElementById('canvas');
if(!cvs || !cvs.getContext){
return;
}
var ctx = cvs.getContext("2d");
if(!ctx){
return;
}
var whichBall=0;
var hitValue = false;
//make a mCoord object to pass to function
var mouseX;
var mouseY;
var touches = [];
var a45 = .7854;
var nuRadius = 0;
var zeroAng = 0;
var gear;
var bSpeed = .02;
var holdMouse = false;
var clutch = {x:0, y:0};
var arcPath = {x:0, y: canvas.height/2,r: 200, angle: 0};
var gCircle ={x:arcPath.x,y:arcPath.y};

var y270 = arcPath.y - arcPath.r - 50;
var y90 = arcPath.y + arcPath.r + 50;
var x0 = arcPath.x + arcPath.r + 50;

var ball = [{x:0, y:0,r:50},{x:0, y:0,r:50},{x:0, y:0,r:50},{x:0, y:0,r:50},{x:0, y:0,r:50}];

var p1 ={x:arcPath.x, y:arcPath.y}; //center point constant
var p2 = {x: mouseX, y:mouseY}; //point from mouse coordinates 
var p3 = {x:arcPath.x + arcPath.r, y:arcPath.y}; //radius point

var rCircle = false;

function touchHandler(event){
    touches = event.changedTouches;
	//alert(touches);
    var first = touches[0];
    var type = "";
	touchX = event.targetTouches[0].pageX;
	touchY = event.targetTouches[0].pageY;
		console.log("touchX" + touchX + "touchY" + touchY);
      switch(event.type){
        case "touchstart": 
		type = "mousedown"; 
		
		break;
		
        case "touchmove":  
		type="mousemove"; 
		break;    
		
        case "touchend":   
		type="mouseup"; 
		break;
        default: 
		return;
    }

             //initMouseEvent(type, canBubble, cancelable, view, clickCount, 
    //           screenX, screenY, clientX, clientY, ctrlKey, 
    //           altKey, shiftKey, metaKey, button, relatedTarget);
    
    var simulatedEvent = document.createEvent("MouseEvent");
    simulatedEvent.initMouseEvent(type, true, true, window, 1, 
                              first.screenX, first.screenY, 
                              first.clientX, first.clientY, false, 
                              false, false, false, 0/*left*/, null);

                                                                                 first.target.dispatchEvent(simulatedEvent);
    event.preventDefault();
}

function hitTest(mouseX,mouseY,circle){
var mX = mouseX;
var mY = mouseY;
var crX = circle.x + circle.r;
var clX = circle.x - circle.r;
var ctY = circle.y - circle.r;
var cbY = circle.y + circle.r;
hitValue = false;
if( (mX < crX) && (mX > clX) && (mY > ctY) &&(mY < cbY) ){
hitValue = true;
}else{
hitValue = false;
}
return hitValue;
}
function cosine(xVal,angVal,radVal){
var cosVal;
cosVal = xVal + Math.cos(angVal) * radVal;
return cosVal;
}
function sine(yVal, angVal, radVal){	
var sineVal;
sineVal = yVal + Math.sin(angVal) * radVal
return sineVal;
}
//find the angle of three points on the canvas
function find_angle(p0,p1,c) {
    var p0c = Math.sqrt(Math.pow(c.x-p0.x,2)+
                        Math.pow(c.y-p0.y,2)); // p0->c (b)   
    var p1c = Math.sqrt(Math.pow(c.x-p1.x,2)+
                        Math.pow(c.y-p1.y,2)); // p1->c (a)
    var p0p1 = Math.sqrt(Math.pow(p1.x-p0.x,2)+
                         Math.pow(p1.y-p0.y,2)); // p0->p1 (c)
    return Math.acos((p1c*p1c+p0c*p0c-p0p1*p0p1)/(2*p1c*p0c));
}

function eMouseMove(event) {	
        if (event.layerX || event.layerX == 0) {
		    mouseX = event.pageX;
            mouseY = event.pageY;
            //mouseX = event.layerX;
            //mouseY = event.layerY;
        } else if (event.offsetX || event.offsetX == 0) {
            mouseX = event.offsetX;
            mouseY = event.offsetY;
        }
    }

function draw(){

ctx.fillStyle ='#eeeeee';
ctx.fillRect(0,0, canvas.width, canvas.height);
ctx.strokeStyle='#000000';
ctx.strokeRect(0,0,canvas.width, canvas.height);

function eClacked(event){
//for(var i = 0, i < touches.length, i++){
//touches.splice(i,1);
//}

holdMouse = false;
bSpeed = 0.02;
rCircle = false;
//console.log("release mouse button " + holdMouse);
}

function eClicked(event){
if(touches[0]){
p2 = {x: touchX, y:touchY}
}else{
p2 = {x: mouseX, y: mouseY}; //point from mouse coordinates 
}

	 
	for(var i = 0; i < ball.length; i++){	
hitTest(p2.x,p2.y,ball[i]);
if(hitValue == true){
whichBall = i;
holdMouse = true;
bSpeed = 0.0;
break;
}
//console.log("hold mouse button " + holdMouse);
}
}
p2 = {x: mouseX, y: mouseY}; //point for mouse
p3 = {x: arcPath.x + arcPath.r, y: arcPath.y}; //radius point

if(holdMouse == true){
	if(mouseY > y270 && mouseY < arcPath.y && mouseX <= x0){
    nuRadius = -(find_angle(p2,p3,p1));
	}else if(mouseY > arcPath.y && mouseY < y90 && mouseX <=x0){
	nuRadius = find_angle(p2,p3,p1);
	}
rCircle = true;
	}
	
clutch.x = cosine(arcPath.x, nuRadius, arcPath.r);
clutch.y = sine(arcPath.y,nuRadius,arcPath.r);

ctx.strokeStyle ="#2EEE09";
ctx.beginPath();
ctx.arc(clutch.x,clutch.y,15,0,Math.PI*2,true);
ctx.stroke();
ctx.closePath();

if(rCircle == true){
ctx.save();
gCircle.x = 0;
gCircle.y = 0;
ctx.setTransform(1,0,0,1,0,0);
ctx.translate(arcPath.x, arcPath.y);
ctx.rotate(nuRadius);
clutch.x = gCircle.x + Math.cos(gear)* arcPath.r;
clutch.y = gCircle.y + Math.sin(gear)* arcPath.r;	
//console.log("angle of gear: " + gear);
}else{
gCircle = {x:arcPath.x,y:arcPath.y};
}

ctx.strokeStyle ="#000000";
ctx.beginPath();
ctx.arc(gCircle.x,gCircle.y,arcPath.r,0,Math.PI*2,true);
ctx.stroke();
ctx.closePath();

for(var i = 0; i < ball.length; i++){

switch(whichBall)
{
case 0:
gear = zeroAng + (i * a45);
//console.log("case 0: " + gear);
break;
case 1:
gear = (zeroAng + (i * a45)) - 0.7854;
//console.log("case 1: " + gear);
break;
case 2:
gear = (zeroAng + (i * a45)) - 1.5708;
//console.log("case 2: " + gear);
break;
case 3:
gear = (zeroAng + (i * a45)) - 2.3552;
//console.log("case 3: " + gear);
break;
case 4:
gear = (zeroAng + (i * a45))- 3.14;
//console.log("case 4: " + gear);
break;
default:
gear = zeroAng + (i * a45);
//console.log("case default: " + gear);
}

ball[i].x = cosine(gCircle.x,gear,arcPath.r);
ball[i].y = sine(gCircle.y, gear, arcPath.r);

ctx.fillStyle = '#e756e8';
ctx.beginPath();
ctx.arc(ball[i].x,ball[i].y,ball[i].r,0,Math.PI*2,true);
ctx.stroke();
ctx.closePath();
}
ctx.restore();
//gear += bSpeed;

cvs.addEventListener('mousemove', eMouseMove, false);
cvs.addEventListener('mousedown', eClicked, false);
cvs.addEventListener('mouseup', eClacked, false);
cvs.addEventListener("touchstart", touchHandler, true);
cvs.addEventListener("touchmove", touchHandler, true);
cvs.addEventListener("touchend", touchHandler, true);
cvs.addEventListener("touchcancel", touchHandler, true); 
}	
const FRAME_RATE = 30;
var intervalTime = 1000/FRAME_RATE;
setInterval(draw, intervalTime);
}
</script>
</body>
</HTML>